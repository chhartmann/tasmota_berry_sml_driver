import serial
import time
ser = serial.Serial("/dev/ttyUSB0", baudrate=9600, parity=serial.PARITY_NONE, stopbits=serial.STOPBITS_ONE)


# from https://github.com/devZer0/libsml-testing
data = """
1B1B1B1B010101017605010203046200620072650000010176010B0A014C4F4700057DECFF050102
03040B00000000000000000000726201650009805C016377CB007605010203046200620072650000070177010B0A014C4F47
00057DECFF070100620AFFFF726201650009805CF106770701006032010101010101044C4F470177070100600100FF010101
010B0A014C4F4700057DECFF0177070100010800FF65001C010401621E52FF69000000000004165B0177070100020800FF01
01621E52FF69000000000002221E0177070100100700FF0101621B52005900000000000000260177070100240700FF010162
1B52005900000000000000130177070100380700FF0101621B520059000000000000000101770701
004C0700FF0101621B52
005900000000000000100177070100200700FF0101622352FF6900000000000009390177070100340700FF0101622352FF69
000000000000093A0177070100480700FF0101622352FF69000000000000094501770701001F0700FF0101622152FE690000
00000000001E0177070100330700FF0101622152FE69000000000000000C0177070100470700FF0101622152FE6900000000
0000000D0177070100510701FF0101620852FF5900000000000004C10177070100510702FF0101620852FF59000000000000
095D0177070100510704FF0101620852FF590000000000000B3A017707010051070FFF0101620852FF590000000000000AAF
017707010051071AFF0101620852FF590000000000000C1201770701000E0700FF0101622C52FF69
00000000000001F50177
07010000020000010101010330360177070100605A02010101010105184A9370010101631DDC007605010203046200620072
6500000201710163BBB500001B1B1B1B1A0154BA"""

def crc16(data: bytes, poly=0x8408):
    data = bytearray(data)
    crc = 0xFFFF
    for b in data:
        cur_byte = 0xFF & b
        for _ in range(0, 8):
            if (crc & 0x0001) ^ (cur_byte & 0x0001):
                crc = (crc >> 1) ^ poly
            else:
                crc >>= 1
            cur_byte >>= 1
        # print("byte " + hex(b) + " " + hex(crc & 0xFFFF))
    crc = (~crc & 0xFFFF)
    crc = (crc << 8) | ((crc >> 8) & 0xFF)
    
    return crc & 0xFFFF


crc_exp = crc16(bytes.fromhex(data)[:-2])
crc_cur = int(data[-4:], 16)
if (crc_exp != crc_cur):
    exit()

bdata = bytes.fromhex(data)
while True:
    ser.write(bdata)
    print("sent msg " + str(len(bdata)))
